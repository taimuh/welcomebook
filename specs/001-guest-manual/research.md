# リサーチ: 民泊ゲストマニュアルシステム

**日付**: 2026-02-05
**ブランチ**: `001-guest-manual`

## 調査項目

### 1. Strapi 5.x コンテンツタイプ設計

**決定**: Strapiの標準コンテンツタイプ機能を使用し、Property、Category、Contentの3つのコレクションタイプを作成する。

**根拠**:
- Strapi 5.xはコレクションタイプ間のリレーション（1対多、多対1）をネイティブサポート
- 管理画面UIはコード不要で自動生成される
- リッチテキストエディタは標準搭載（Markdown/WYSIWYG）
- 画像アップロードは標準のMedia Libraryで対応
- TypeScriptで完全書き直しされ、ビルド高速化（Vite使用）
- Strapi 4.xは2026年4月にEOL

**検討した代替案**:
- Strapi 4.x: 2026年4月にサポート終了のため不採用
- カスタムCMS構築: 工数過大、憲法のシンプルさ原則に反する

### 2. Next.js App Router データフェッチング戦略

**決定**: Server ComponentsでのデータフェッチングとISR（Incremental Static Regeneration）を組み合わせる。

**根拠**:
- Server Componentsはクライアントバンドルを削減し、初期表示を高速化
- ISRにより静的生成の恩恵を受けつつ、コンテンツ更新を反映可能
- revalidate設定（30秒）で仕様の「30秒以内に反映」を達成
- 検索機能はクライアントコンポーネントで実装（インタラクティブ性が必要）

**検討した代替案**:
- 完全SSR: Vercel無料枠でのサーバーレス関数実行時間制限に抵触リスク
- 完全CSR: SEO不利、初期表示遅延

### 3. 検索機能の実装方式

**決定**: Strapi REST APIのフィルタリング機能（`$containsi`）を使用したサーバーサイド検索。

**根拠**:
- Strapi 4.xは`filters[$or]`と`$containsi`（大文字小文字無視の部分一致）をサポート
- 日本語検索に対応（PostgreSQLのLIKE演算子ベース）
- 外部検索エンジン不要でコスト$0を維持
- 想定データ量（1000コンテンツ）では十分なパフォーマンス

**検討した代替案**:
- Algolia: 高性能だが無料枠超過のリスク
- MeiliSearch: セルフホストが必要、Railway無料枠を圧迫
- フロントエンド検索: データ量増加時にパフォーマンス劣化

### 4. 物件URLスラッグのバリデーション

**決定**: 英小文字、数字、ハイフンのみ許可。3〜50文字。システム全体で一意制約。

**根拠**:
- URL安全な文字のみ使用（エンコード不要）
- オーナーが覚えやすい長さ
- Strapiのunique制約で一意性を保証
- フロントエンドとバックエンド両方でバリデーション

**バリデーションルール**:
```regex
^[a-z0-9][a-z0-9-]{1,48}[a-z0-9]$
```

### 5. 画像ストレージ戦略

**決定**: Strapi標準のローカルプロバイダーを使用し、RailwayのボリュームまたはCloudinary無料枠を検討。

**根拠**:
- Strapi Media Libraryは画像アップロード、サイズ制限、形式検証を標準サポート
- Railway無料枠内では永続ストレージに制限あり
- 将来的にCloudinary（無料枠25GB）への移行パスを確保

**検討した代替案**:
- AWS S3: 無料枠超過リスク、設定複雑
- Vercel Blob: 有料機能

### 6. デフォルトカテゴリの自動作成

**決定**: Strapiのライフサイクルフック（`afterCreate`）を使用して物件作成時にデフォルトカテゴリを自動生成。

**根拠**:
- Strapi 4.xはモデルライフサイクルフックをサポート
- ビジネスロジックをバックエンドに集約
- フロントエンド側での追加API呼び出し不要

**デフォルトカテゴリ**:
1. 🏠 設備の使い方（order: 1）
2. 📋 ハウスルール（order: 2）
3. 📍 周辺情報（order: 3）
4. 🆘 緊急時の対応（order: 4）

### 7. 認証とオーナー分離

**決定**: Strapiのデフォルトユーザー認証を使用。オーナーは自分の物件のみ編集可能とするポリシーを実装。

**根拠**:
- Strapi Users & Permissions プラグインは標準搭載
- `isOwner`ポリシーでデータアクセス制御
- JWT認証でステートレス

**検討した代替案**:
- カスタム認証: 工数過大
- 外部認証プロバイダー: 複雑性増加

## 未解決事項

なし - 全ての技術的不明点は解消済み

## 次のステップ

Phase 1: データモデル設計とAPI契約の作成へ進む
