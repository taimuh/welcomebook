# 機能仕様書: 民泊ゲストマニュアルシステム (WelcomeBook)

**機能ブランチ**: `001-guest-manual`
**作成日**: 2026-02-05
**ステータス**: 下書き
**最終更新**: 2026-02-05
**入力**: ユーザー説明: "システムの目的：民泊を運営する中でゲストへのマニュアルや情報を提供するシステム。オーナーが容易にコンテンツを更新できる環境を提供する。ゲスト向け機能（フロントエンド）：マニュアル閲覧、検索機能。オーナー向け機能（Strapi管理画面）：コンテンツ管理、物件管理、カテゴリ管理"

## 概要

民泊オーナーがゲスト向けのマニュアル・情報を簡単に管理・公開できるシステム。ゲストは物件固有のURLからスマートフォンでマニュアルを閲覧し、滞在に必要な情報（Wi-Fi、家電、ルールなど）を確認できる。

## 明確化事項

### セッション 2026-02-05

- Q: 物件URLスラッグの生成方法は？ → A: オーナーが任意のスラッグを指定（例: tokyo-shibuya-apt）
- Q: コンテンツのサマリー表示方法は？ → A: 本文の先頭100文字を自動抽出
- Q: カテゴリアイコンの指定方法は？ → A: 絵文字を直接入力（例: 🏠 📺 🗑️）

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - ゲストがマニュアルを閲覧する (優先度: P1)

ゲストは民泊に到着後、Wi-Fiの接続方法、家電の使い方、ゴミの出し方、チェックアウト手順など、滞在に必要な情報をスマートフォンやタブレットから確認したい。

**優先度の理由**: これがシステムの核心機能であり、ゲストの滞在体験を直接向上させる。この機能なしではシステムの存在意義がない。

**独立テスト**: ゲストがURLにアクセスし、物件のマニュアル一覧を表示し、目的の情報を読むことができれば成功。

**受け入れシナリオ**:

1. **前提** ゲストが物件固有のURLにアクセスした, **操作** ページが表示される, **結果** その物件に関連するマニュアルのカテゴリ一覧が表示される
2. **前提** ゲストがカテゴリを選択した, **操作** カテゴリ内のコンテンツ一覧が表示される, **結果** 各コンテンツのタイトルとサマリーが表示される
3. **前提** ゲストが特定のコンテンツを選択した, **操作** コンテンツ詳細ページが開く, **結果** テキスト、画像、手順などの完全な情報が表示される
4. **前提** ゲストがスマートフォンでアクセスした, **操作** ページが表示される, **結果** モバイル画面に最適化されたレイアウトで表示される
5. **前提** ゲストが物件トップページを表示している, **操作** 物件情報を確認する, **結果** 物件名、ウェルカムメッセージ、緊急連絡先が表示される

---

### ユーザーストーリー 2 - ゲストがマニュアルを検索する (優先度: P2)

ゲストは特定の情報（例：「エアコン」「Wi-Fi」「ゴミ」）を素早く見つけるため、キーワードで検索したい。

**優先度の理由**: カテゴリからの閲覧だけでは目的の情報にたどり着くのに時間がかかる場合がある。検索機能はゲスト体験を大幅に向上させる。

**独立テスト**: 検索バーにキーワードを入力し、関連するコンテンツが検索結果として表示されることで確認できる。

**受け入れシナリオ**:

1. **前提** ゲストがマニュアルページを開いている, **操作** 検索バーにキーワードを入力する, **結果** 入力したキーワードを含むコンテンツが検索結果として表示される
2. **前提** ゲストが検索を実行した, **操作** 該当するコンテンツがない, **結果** 「該当する情報が見つかりませんでした」というメッセージが表示される
3. **前提** ゲストが検索結果から1つを選択した, **操作** 詳細ページが表示される, **結果** 検索キーワードに該当する部分がハイライト表示される
4. **前提** ゲストが部分一致するキーワードを入力した, **操作** 検索を実行する, **結果** 「エアコン」で「エアコンの使い方」と「エアコンのリモコン」の両方がヒットする

---

### ユーザーストーリー 3 - オーナーがコンテンツを管理する (優先度: P1)

オーナーは管理画面からマニュアルコンテンツ（テキスト、画像、手順）を作成・編集・削除したい。技術的な知識がなくても簡単に更新できる必要がある。

**優先度の理由**: オーナーがコンテンツを更新できなければ、システムは陳腐化し価値を失う。ゲスト閲覧と同等に重要な核心機能。

**独立テスト**: オーナーが管理画面にログインし、新しいコンテンツを作成して公開し、フロントエンドで表示されることを確認できる。

**受け入れシナリオ**:

1. **前提** オーナーが管理画面にログインしている, **操作** 新規コンテンツ作成を選択する, **結果** タイトル、本文、画像、カテゴリ、表示順、公開状態を入力できるフォームが表示される
2. **前提** オーナーがコンテンツを作成した, **操作** 「公開」状態で保存する, **結果** フロントエンドで該当物件のゲストがそのコンテンツを閲覧できる
3. **前提** オーナーがコンテンツを作成した, **操作** 「下書き」状態で保存する, **結果** フロントエンドには表示されないが、管理画面では確認できる
4. **前提** オーナーが既存コンテンツを編集した, **操作** 変更を保存する, **結果** フロントエンドに変更が即座に反映される
5. **前提** オーナーがコンテンツを削除した, **操作** 削除を確定する, **結果** フロントエンドからそのコンテンツが表示されなくなる
6. **前提** オーナーが本文を編集している, **操作** リッチテキストエディタを使用する, **結果** 見出し、太字、リスト、リンクなどの書式設定ができる

---

### ユーザーストーリー 4 - オーナーが物件を管理する (優先度: P1)

オーナーは複数の民泊物件を運営している場合、各物件の情報を個別に管理したい。

**優先度の理由**: 物件ごとにマニュアルを分離することで、ゲストに正確な情報を提供できる。複数物件運営者にとって必須。

**独立テスト**: オーナーが新しい物件を登録し、その物件固有のURLでアクセスした際に、その物件のコンテンツのみが表示される。

**受け入れシナリオ**:

1. **前提** オーナーが管理画面にログインしている, **操作** 新規物件を登録する, **結果** 物件名、所在地、説明、ウェルカムメッセージ、緊急連絡先を入力できる
2. **前提** オーナーが物件を登録した, **操作** オーナーが任意のURLスラッグを指定する, **結果** そのスラッグを使ったURLでゲストがアクセスできる
3. **前提** オーナーがコンテンツを作成する際, **操作** 物件を選択する, **結果** そのコンテンツは選択した物件にのみ関連付けられる
4. **前提** オーナーが新規物件を登録した, **操作** 保存を完了する, **結果** デフォルトカテゴリ（設備の使い方、ハウスルール、周辺情報、緊急時の対応）が自動作成される

---

### ユーザーストーリー 5 - オーナーがカテゴリを管理する (優先度: P2)

オーナーはマニュアルコンテンツを整理するため、カテゴリ（例：設備の使い方、ハウスルール、周辺情報）を作成・編集・並び替えしたい。

**優先度の理由**: 適切なカテゴリ構成によりゲストが情報を見つけやすくなる。コンテンツ管理の補助機能として重要。

**独立テスト**: オーナーが新しいカテゴリを作成し、そのカテゴリがフロントエンドのナビゲーションに表示される。

**受け入れシナリオ**:

1. **前提** オーナーが管理画面にログインしている, **操作** 新規カテゴリを作成する, **結果** カテゴリ名、説明、アイコン、表示順を設定できる
2. **前提** オーナーがカテゴリの表示順を変更した, **操作** 変更を保存する, **結果** フロントエンドのカテゴリ一覧の順序が更新される
3. **前提** カテゴリにコンテンツが紐付いている, **操作** オーナーがそのカテゴリを削除しようとする, **結果** 警告メッセージが表示され、コンテンツの移動先を選択するよう促される
4. **前提** カテゴリにコンテンツが紐付いていない, **操作** オーナーがそのカテゴリを削除する, **結果** カテゴリが削除される

---

### ユーザーストーリー 6 - オーナーが画像を管理する (優先度: P2)

オーナーはコンテンツに画像を追加して、ゲストに視覚的にわかりやすい説明を提供したい。

**優先度の理由**: 家電の操作方法やゴミの分別など、画像があると理解しやすい内容が多い。

**独立テスト**: オーナーが画像をアップロードし、コンテンツに表示されることを確認できる。

**受け入れシナリオ**:

1. **前提** オーナーがコンテンツを編集している, **操作** 画像をアップロードする, **結果** 画像がコンテンツに挿入される
2. **前提** オーナーが5MB以上の画像をアップロードしようとした, **操作** アップロードを実行する, **結果** 「画像サイズは5MB以下にしてください」というエラーが表示される
3. **前提** オーナーがコンテンツに画像を追加している, **操作** 11枚目の画像をアップロードしようとする, **結果** 「1コンテンツあたり画像は10枚までです」というエラーが表示される
4. **前提** オーナーがJPEG、PNG、GIF、WebP以外の形式をアップロードしようとした, **操作** アップロードを実行する, **結果** 「対応していない画像形式です」というエラーが表示される

---

### エッジケース

- ゲストがインターネット接続の不安定な環境でアクセスした場合、ページの読み込みが途中で失敗しても適切なエラーメッセージを表示する
- オーナーが誤ってすべてのコンテンツを削除した場合でも、ゲスト向けページは「現在コンテンツがありません」と表示し、エラーにならない
- 複数のオーナーが同時に同じコンテンツを編集しようとした場合、後から保存した変更で上書きされる旨を通知する
- 物件URLが無効または存在しない場合、ゲストに「この物件は見つかりません」というメッセージを表示する
- 検索クエリが空の場合、検索は実行されずすべてのコンテンツが表示される
- 公開状態のコンテンツがないカテゴリは、ゲスト向けページに表示されない
- 物件にカテゴリが1つもない場合、「カテゴリがありません」とゲストに表示される
- オーナーが物件を削除しようとした場合、関連するすべてのカテゴリとコンテンツも削除される旨の警告を表示する

## 要件 *(必須)*


### 機能要件

**ゲスト向け機能**

- **FR-001**: システムは物件固有のURLでアクセスした際、その物件に関連するマニュアルコンテンツのみを表示しなければならない
- **FR-002**: システムはカテゴリ別にコンテンツを一覧表示し、各コンテンツのサマリー（本文先頭100文字を自動抽出）を表示しなければならない
- **FR-003**: システムはコンテンツの詳細（テキスト、画像、手順）を表示しなければならない
- **FR-004**: システムはキーワード検索機能を提供し、コンテンツのタイトルと本文を検索対象としなければならない
- **FR-005**: システムはスマートフォン、タブレット、PCの各画面サイズに対応したレスポンシブデザインを提供しなければならない
- **FR-006**: システムは日本語でコンテンツを表示しなければならない
- **FR-007**: システムは「公開」状態のコンテンツのみをゲストに表示しなければならない
- **FR-008**: システムは物件トップページに物件名、ウェルカムメッセージ、緊急連絡先を表示しなければならない

**オーナー向け機能（管理画面）**

- **FR-009**: オーナーは管理画面にログインして認証されなければならない
- **FR-010**: オーナーはコンテンツを作成・編集・削除できなければならない
- **FR-011**: オーナーはコンテンツの公開状態（下書き/公開）を設定できなければならない
- **FR-012**: オーナーはコンテンツの表示順を設定できなければならない
- **FR-013**: オーナーは物件情報を登録・編集・削除できなければならない
- **FR-014**: オーナーはカテゴリを作成・編集・削除・並び替えできなければならない
- **FR-015**: オーナーはコンテンツに画像をアップロードして表示できなければならない
- **FR-016**: システムは各コンテンツを特定の物件とカテゴリに関連付けて管理しなければならない
- **FR-017**: システムはコンテンツの変更を30秒以内にフロントエンドに反映しなければならない
- **FR-018**: システムは新規物件登録時にデフォルトカテゴリを自動作成しなければならない
- **FR-019**: オーナーはリッチテキストエディタを使用してコンテンツ本文を編集できなければならない

**画像管理**

- **FR-020**: システムは1コンテンツあたり最大10枚の画像アップロードを許可しなければならない
- **FR-021**: システムは1画像あたり最大5MBのファイルサイズ制限を設けなければならない
- **FR-022**: システムはJPEG、PNG、GIF、WebP形式の画像のみを受け付けなければならない

### 主要エンティティ

- **物件 (Property)**: 民泊施設を表す。物件名、所在地、説明、ウェルカムメッセージ、緊急連絡先、固有URLスラッグ（オーナーが任意指定、英数字とハイフンのみ、システム全体で一意）を持つ。1つの物件は複数のコンテンツとカテゴリを持てる。
- **カテゴリ (Category)**: コンテンツを分類するグループ。カテゴリ名、説明、アイコン（絵文字）、表示順を持つ。物件に紐付き、複数のコンテンツを含む。
- **コンテンツ (Content)**: マニュアルの実際の情報。タイトル、本文（リッチテキスト）、画像（複数可）、表示順、公開状態、作成日、更新日を持つ。1つの物件と1つのカテゴリに紐付く。
- **オーナー (Owner)**: 管理画面を操作するユーザー。メールアドレス、パスワード、名前を持つ。複数の物件を所有できる。

## 成功基準 *(必須)*

### 計測可能な成果

- **SC-001**: ゲストは3タップ以内で目的のコンテンツにたどり着ける（カテゴリ選択→コンテンツ選択→詳細表示）
- **SC-002**: ゲストは検索キーワード入力後2秒以内に検索結果を確認できる
- **SC-003**: オーナーは技術的なサポートなしで新規コンテンツを5分以内に作成・公開できる
- **SC-004**: オーナーが保存した変更は30秒以内にフロントエンドに反映される
- **SC-005**: システムは同時に100人のゲストがアクセスしても正常に動作する
- **SC-006**: ゲスト向けページはモバイル端末で3秒以内に初期表示される
- **SC-007**: オーナーの90%が初回利用時に使い方のガイドなしでコンテンツを作成できる
- **SC-008**: ゲストの80%が必要な情報を見つけるのに3分以内で完了する

## 前提条件

- ゲストは物件固有のURLを事前に知っている（QRコード、メール、予約サイト経由で共有される）
- ゲストは認証なしでマニュアルを閲覧できる（ログイン不要）
- 管理画面はStrapiを使用する（ユーザー入力で指定）
- オーナー認証はStrapi標準のユーザー管理機能を使用する（カスタム実装不要、FR-009充足）
- 1つの物件には1人のオーナーが紐付く（共同オーナーは初期スコープ外）
- コンテンツは日本語のみ対応（多言語対応は初期スコープ外）
- 画像アップロードはJPEG、PNG、GIF、WebP形式に対応
- オフラインアクセスは初期スコープ外
- デフォルトカテゴリは「設備の使い方」「ハウスルール」「周辺情報」「緊急時の対応」の4つ
- リッチテキストエディタは見出し、太字、斜体、リスト、リンクの書式をサポート

## スコープ外

- ゲストのユーザー登録・ログイン機能
- 多言語対応（日本語のみ）
- オフラインアクセス・PWA機能
- ゲストからオーナーへのフィードバック・問い合わせ機能
- 予約システムとの連携
- 複数オーナーによる同一物件の共同管理
- コンテンツのバージョン管理・履歴機能
- アクセス解析・統計機能
- 画像の自動リサイズ・圧縮
- 動画のアップロード・埋め込み

## テスト戦略 *(必須)*

### テスト原則

- 各機能の実装完了時に対応するテストを作成・実行する
- ユーザーストーリーごとに独立してテスト可能な状態を維持する
- 受け入れシナリオをE2Eテストとして自動化する
- CIパイプラインで全テストを実行し、失敗時はマージを禁止する

### テストレベル

**ユニットテスト（Jest + React Testing Library）**

- **対象**: APIクライアント関数、ユーティリティ関数、個別コンポーネント
- **カバレッジ目標**: ビジネスロジックを含む関数は80%以上
- **実行タイミング**: 各機能実装完了時、PR作成時、CI

**統合テスト（Jest + MSW）**

- **対象**: APIクライアントとStrapiの連携、コンポーネント間の連携
- **シナリオ**: APIレスポンスのモック、エラーハンドリング確認
- **実行タイミング**: 各ユーザーストーリー完了時、CI

**E2Eテスト（Playwright）**

- **対象**: 各ユーザーストーリーの受け入れシナリオ
- **シナリオ**: ゲストの閲覧フロー、検索機能、オーナーのCRUD操作
- **実行タイミング**: 各フェーズ完了時、リリース前、CI

### ユーザーストーリー別テスト要件

| ストーリー | ユニットテスト | 統合テスト | E2Eテスト |
|-----------|--------------|-----------|----------|
| US1（マニュアル閲覧） | APIクライアント関数、各コンポーネント | Strapi連携 | 受け入れシナリオ1-5 |
| US2（検索） | 検索関数、ハイライト処理 | 検索API連携 | 受け入れシナリオ1-4 |
| US3（コンテンツ管理） | サマリー計算、公開フィルタ | CRUD操作 | 受け入れシナリオ1-6 |
| US4（物件管理） | スラッグバリデーション | ライフサイクルフック | 受け入れシナリオ1-4 |
| US5（カテゴリ管理） | 並び替えロジック | 削除警告 | 受け入れシナリオ1-4 |
| US6（画像管理） | 画像バリデーション | アップロード制限 | 受け入れシナリオ1-4 |

### エッジケーステスト

各エッジケースに対してテストを作成する：

- **ネットワークエラー時のエラーメッセージ表示**
- **空コンテンツ時の適切なメッセージ表示**
- **無効な物件URLへのアクセス時の404表示**
- **空検索クエリ時の動作**
- **公開コンテンツなしカテゴリの非表示**
- **物件削除時の警告表示**

### 成功基準のテスト

成功基準（SC-001〜SC-008）を検証するテストを作成する：

- **SC-001**: 3タップ以内でコンテンツ到達（E2Eで検証）
- **SC-002**: 検索結果2秒以内（パフォーマンステストで検証）
- **SC-006**: 初期表示3秒以内（Lighthouse CIで検証）

### テスト環境

- **ローカル開発**: Jest watch mode、Playwright UIモード
- **CI環境**: GitHub Actions、全テスト自動実行
- **テストデータ**: フィクスチャファイルで管理、各テスト前にリセット
